<!-- 通用表单抽屉组件 -->
<script type="text/html" id="form-drawer-template">
  <v-navigation-drawer
    v-if="value"
    :value="value"
    @input="$emit('input', $event)"
    :permanent="value"
    fixed
    temporary
    right
    :width="width"
    class="elevation-24 jh-form-drawer">

    <v-form :ref="formRef" lazy-validation>
      <!-- 抽屉标题 -->
      <v-row class="jh-drawer-header px-4 relative pl-[30px] md:pl-0" no-gutters align="center">
        <!-- 取消icon (移动端) -->
        <v-icon v-if="isMobile" @click="handleClose" class="mr-2">mdi-chevron-left</v-icon>

        <div class="flex justify-center py-3 flex-1 w-full align-center">
          <span class="text-h7 font-weight-bold">{{ title }}</span>
          <v-spacer></v-spacer>
        </div>

        <!-- 抽屉操作按钮 -->
        <div class="jh-drawer-action-btn-group pa-3" v-if="actions && actions.length > 0">
          <div class="w-full gap-x-3 grid grid-cols-[repeat(auto-fit,minmax(50px,1fr))] gap-2">
            <v-btn
              v-for="(action, index) in actions"
              :key="index"
              :color="action.color || 'success'"
              class="ml-2"
              small
              @click="action.handler">
              {{ action.label }}
            </v-btn>
          </div>
        </div>
      </v-row>

      <v-divider class="jh-divider"></v-divider>

      <!-- 抽屉内容 (插槽) -->
      <div class="jh-drawer-content">
        <slot></slot>
      </div>
    </v-form>

    <!-- 抽屉关闭按钮 (PC端) -->
    <v-btn
      v-if="!isMobile && showCloseButton"
      elevation="0"
      color="success"
      fab
      absolute
      top
      left
      small
      tile
      class="drawer-close-float-btn"
      @click="handleClose">
      <v-icon>mdi-close</v-icon>
    </v-btn>
  </v-navigation-drawer>
</script>

<script>
Vue.component('form-drawer', {
  template: '#form-drawer-template',
  props: {
    // v-model 双向绑定
    value: {
      type: Boolean,
      default: false
    },
    // 抽屉标题
    title: {
      type: String,
      default: '表单'
    },
    // 抽屉宽度
    width: {
      type: String,
      default: '90%'
    },
    // 操作按钮配置数组
    // 格式: [{ label: '保存', color: 'success', handler: () => {} }]
    actions: {
      type: Array,
      default: () => []
    },
    // 表单ref名称
    formRef: {
      type: String,
      default: 'drawerForm'
    },
    // 是否显示关闭按钮
    showCloseButton: {
      type: Boolean,
      default: true
    },
    // 关闭前的确认回调
    onBeforeClose: {
      type: Function,
      default: null
    }
  },
  data() {
    return {
      isMobile: window.innerWidth < 500
    }
  },
  mounted() {
    window.addEventListener('resize', this.handleResize);
  },
  beforeDestroy() {
    window.removeEventListener('resize', this.handleResize);
  },
  methods: {
    handleResize() {
      this.isMobile = window.innerWidth < 500;
    },
    async handleClose() {
      // 如果有关闭前回调,先执行
      if (this.onBeforeClose) {
        const shouldClose = await this.onBeforeClose();
        if (shouldClose === false) {
          return;
        }
      }
      this.$emit('input', false);
      this.$emit('close');
    },
    // 暴露表单验证方法
    async validate() {
      return await this.$refs[this.formRef].validate();
    },
    // 重置表单验证
    resetValidation() {
      this.$refs[this.formRef].resetValidation();
    }
  }
});
</script>

<style scoped>
/* 抽屉样式 */
.jh-form-drawer .jh-drawer-header {
  background-color: #f5f5f5;
  border-bottom: 1px solid #e0e0e0;
  min-height: 64px;
}

.jh-form-drawer .jh-drawer-action-btn-group {
  display: flex;
  align-items: center;
  gap: 8px;
}

.jh-form-drawer .jh-drawer-content {
  overflow-y: auto;
  height: calc(100vh - 65px);
}

.jh-form-drawer .jh-drawer-content .row {
  margin-top: 0;
  padding: 16px;
  padding-bottom: 16px;
}

.jh-form-drawer .drawer-close-float-btn {
  z-index: 10;
  margin-left: -28px;
  margin-top: 16px;
}

.jh-form-drawer .jh-divider {
  margin: 0;
}

/* 移动端适配 */
@media (max-width: 600px) {
  .jh-form-drawer .jh-drawer-header {
    min-height: 56px;
  }

  .jh-form-drawer .drawer-close-float-btn {
    display: none;
  }
}

/* 表单输入标签样式 */
.jh-form-drawer .jh-input-label {
  display: block;
  font-size: 14px;
  color: rgba(0, 0, 0, 0.6);
  margin-bottom: 4px;
  font-weight: 500;
}

.jh-form-drawer .jh-input-label .red--text {
  color: #f44336;
}

/* 表单输入框样式 */
.jh-form-drawer .jh-v-input {
  margin-top: 0;
}

.jh-form-drawer .jh-v-input .v-input__control {
  min-height: 40px;
}
</style>
