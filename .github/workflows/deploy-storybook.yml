name: Deploy Storybook and Build CDN Package

on:
  # 当推送到 main 分支时触发
  push:
    branches:
      - main

  # 允许手动触发
  workflow_dispatch:

# 设置 GitHub Pages 部署权限
permissions:
  contents: read
  pages: write
  id-token: write

# 只允许一个并发部署
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  # 构建 Storybook 和 CDN 包
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build CDN Package
        run: npm run build

      - name: Build Storybook
        run: npm run build-storybook

      - name: Copy CDN files to Storybook static
        run: |
          mkdir -p storybook-static/cdn
          cp -r dist/* storybook-static/cdn/
          
      - name: Create CDN usage example
        run: |
          cat > storybook-static/cdn-example.html << 'EOF'
          <!DOCTYPE html>
          <html lang="zh-CN">
          <head>
            <meta charset="utf-8">
            <meta name="viewport" content="width=device-width,initial-scale=1.0">
            <title>JianghuJS UI - CDN 使用示例</title>
            
            <!-- Vuetify CSS -->
            <link href="https://cdn.jsdelivr.net/npm/vuetify@2.7.0/dist/vuetify.min.css" rel="stylesheet">
            <!-- Material Design Icons -->
            <link href="https://cdn.jsdelivr.net/npm/@mdi/font@7.x/css/materialdesignicons.min.css" rel="stylesheet">
            <!-- JianghuJS UI CSS -->
            <link href="./cdn/jianghu-ui.css" rel="stylesheet">
          </head>
          <body>
            <div id="app">
              <v-app>
                <v-main>
                  <v-container>
                    <h1>JianghuJS UI CDN 示例</h1>
                    <p>CDN 文件地址：</p>
                    <ul>
                      <li>JS: <code>https://你的用户名.github.io/jianghu-ui/cdn/jianghu-ui.js</code></li>
                      <li>CSS: <code>https://你的用户名.github.io/jianghu-ui/cdn/jianghu-ui.css</code></li>
                    </ul>
                    
                    <!-- 使用 JhTable 组件示例 -->
                    <v-card class="mt-4">
                      <v-card-title>JhTable 组件示例</v-card-title>
                      <v-card-text>
                        <jh-table
                          :headers="headers"
                          :items="items"
                        ></jh-table>
                      </v-card-text>
                    </v-card>
                  </v-container>
                </v-main>
              </v-app>
            </div>

            <!-- 依赖库 -->
            <script src="https://cdn.jsdelivr.net/npm/vue@2.7.16/dist/vue.js"></script>
            <script src="https://cdn.jsdelivr.net/npm/vuetify@2.7.0/dist/vuetify.min.js"></script>
            
            <!-- JianghuJS UI -->
            <script src="./cdn/jianghu-ui.js"></script>

            <script>
              new Vue({
                el: '#app',
                vuetify: new Vuetify(),
                data: {
                  headers: [
                    { text: 'ID', value: 'id' },
                    { text: '名称', value: 'name' },
                    { text: '状态', value: 'status' }
                  ],
                  items: [
                    { id: 1, name: '项目A', status: '进行中' },
                    { id: 2, name: '项目B', status: '已完成' }
                  ]
                }
              });
            </script>
          </body>
          </html>
          EOF

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./storybook-static

  # 部署到 GitHub Pages
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
