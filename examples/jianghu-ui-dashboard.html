<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>jianghu-ui 页面示例 - 面板 + 表格 + 表单</title>
    <!-- 第三方依赖 -->
    <link
      href="https://cdn.jsdelivr.net/npm/@mdi/font@7.4.47/css/materialdesignicons.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/vuetify@2.7.0/dist/vuetify.min.css"
      rel="stylesheet"
    />
    <!-- jianghu-ui 样式（使用本地 dist，发布时可替换为 CDN 地址） -->
    <link href="../dist/jianghu-ui.css" rel="stylesheet" />
    <style>
      body {
        background: #f4f5f7;
      }

      .page-title {
        font-size: 28px;
        font-weight: 600;
        margin-bottom: 4px;
      }

      .page-subtitle {
        color: #666;
      }

      .jh-card + .jh-card {
        margin-top: 16px;
      }

      .kpi-value {
        font-size: 32px;
        font-weight: 600;
      }

      .kpi-desc {
        color: #808191;
      }
    </style>
  </head>
  <body>
    <div id="app">
      <v-app>
        <v-main>
          <v-container>
            <div class="mb-8">
              <div class="page-title">项目管理演示页</div>
              <div class="page-subtitle">
                演示 JhCard + JhTable + JhForm 等 jianghu-ui 组件协同完成一个可用页面
              </div>
            </div>

            <v-row dense>
              <v-col cols="12" md="4">
                <jh-card title="进行中项目" tooltip="同步后端接口返回的业务指标">
                  <div class="kpi-value">{{ statistics.running }}</div>
                  <div class="kpi-desc">最近 7 天新增 {{ statistics.runningDelta }} 个</div>
                </jh-card>
              </v-col>
              <v-col cols="12" md="4">
                <jh-card title="已交付">
                  <div class="kpi-value">{{ statistics.finished }}</div>
                  <div class="kpi-desc">交付成功率 {{ statistics.deliveryRate }}%</div>
                </jh-card>
              </v-col>
              <v-col cols="12" md="4">
                <jh-card title="风险项目" collapsible>
                  <div class="kpi-value">{{ statistics.risk }}</div>
                  <div class="kpi-desc">需要优先跟进 {{ statistics.riskOwners.length }} 位负责人</div>
                </jh-card>
              </v-col>
            </v-row>

            <jh-card title="项目列表" class="mt-8">
              <template #extra>
                <v-chip color="primary" small text-color="white" class="mr-2">
                  所选 {{ selectedRows.length }} 项
                </v-chip>
                <v-btn text small color="primary" @click="refreshTable">
                  <v-icon left small>mdi-refresh</v-icon>
                  立即刷新
                </v-btn>
              </template>

              <jh-table
                ref="projectTable"
                class="mt-4"
                header-title="研发项目"
                tooltip="演示基于 request 的服务端分页"
                :headers="projectHeaders"
                :request="loadProjects"
                :polling="0"
                :show-select="true"
                :show-filter="true"
                :filter-fields="projectFilterFields"
                :toolbar="{ search: true, refresh: true, density: true, setting: true }"
                :action-column="false"
                @create-click="openCreateForm"
                @selection-change="onTableSelection"
              >
                <template #toolbar-actions>
                  <v-btn color="success" small @click="openCreateForm">
                    <v-icon left small>mdi-plus</v-icon>
                    新增项目
                  </v-btn>
                  <v-btn
                    outlined
                    color="primary"
                    small
                    class="ml-2"
                    @click="exportSelected"
                  >
                    <v-icon left small>mdi-download</v-icon>
                    导出所选
                  </v-btn>
                </template>

                <template #item.status="{ item }">
                  <v-chip
                    small
                    :color="statusColorMap[item.status] || 'grey'"
                    dark
                  >
                    {{ statusTextMap[item.status] || '未知' }}
                  </v-chip>
                </template>

                <template #item.priority="{ item }">
                  <v-rating
                    :value="priorityMap[item.priority]"
                    color="amber"
                    dense
                    half-increments
                    readonly
                  ></v-rating>
                </template>

                <template #item.actions="{ item }">
                  <v-btn icon small @click="openEditForm(item)">
                    <v-icon small color="primary">mdi-pencil</v-icon>
                  </v-btn>
                  <v-btn icon small @click="markFinished(item)">
                    <v-icon small color="success">mdi-check</v-icon>
                  </v-btn>
                </template>
              </jh-table>
            </jh-card>

            <jh-card title="快速录入" class="mt-8" header-bordered>
              <jh-form
                :fields="quickFormFields"
                :initial-data="quickFormData"
                layout="horizontal"
                @submit="handleQuickSubmit"
                @change="handleQuickChange"
              >
                <template #actions="{ validate, resetForm }">
                  <v-btn text color="primary" class="mr-4" @click="resetForm">重置</v-btn>
                  <v-btn color="primary" @click="validate">提交</v-btn>
                </template>
              </jh-form>
            </jh-card>

            <jh-modal-form
              v-model="modalVisible"
              :title="modalTitle"
              :fields="modalFields"
              :initial-data="currentProject"
              :validate-before-confirm="true"
              @confirm="handleModalConfirm"
              @close="handleModalClose"
            />

            <jh-toast
              v-model="toast.visible"
              :message="toast.message"
              :type="toast.type"
              position="top-right"
            />
          </v-container>
        </v-main>
      </v-app>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/vue@2.7.16/dist/vue.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vuetify@2.7.0/dist/vuetify.js"></script>
    <script src="../dist/jianghu-ui.js"></script>
    <script>
      // 演示数据，真实业务中请替换为接口请求结果
      const mockProjects = [
        {
          id: 1,
          name: '江湖 CRM 重构',
          owner: '陈晓',
          status: 'running',
          priority: 'high',
          members: 12,
          updatedAt: '2025-02-01',
        },
        {
          id: 2,
          name: '移动端审批',
          owner: '刘伟',
          status: 'planning',
          priority: 'medium',
          members: 8,
          updatedAt: '2025-01-28',
        },
        {
          id: 3,
          name: 'BI 可视化',
          owner: '赵云',
          status: 'running',
          priority: 'critical',
          members: 5,
          updatedAt: '2025-01-25',
        },
        {
          id: 4,
          name: '统一登录',
          owner: '林雪',
          status: 'finished',
          priority: 'low',
          members: 4,
          updatedAt: '2025-01-19',
        },
      ];

      new Vue({
        el: '#app',
        vuetify: new Vuetify(),
        data() {
          return {
            statistics: {
              running: 8,
              runningDelta: 3,
              finished: 24,
              deliveryRate: 94,
              risk: 2,
              riskOwners: ['刘伟', '林雪'],
            },
            projectHeaders: [
              { text: '项目名称', value: 'name', sortable: true, minWidth: 200 },
              { text: '负责人', value: 'owner', width: 140 },
              { text: '状态', value: 'status', width: 140 },
              { text: '优先级', value: 'priority', width: 160 },
              { text: '成员数', value: 'members', width: 120 },
              { text: '最近更新时间', value: 'updatedAt', sortable: true, width: 180 },
              { text: '操作', value: 'actions', sortable: false, width: 140 },
            ],
            projectFilterFields: [
              { key: 'name', label: '项目名称', type: 'text', placeholder: '输入关键字' },
              {
                key: 'status',
                label: '状态',
                type: 'select',
                options: [
                  { text: '规划中', value: 'planning' },
                  { text: '进行中', value: 'running' },
                  { text: '已交付', value: 'finished' },
                ],
              },
              {
                key: 'priority',
                label: '优先级',
                type: 'select',
                options: [
                  { text: '低', value: 'low' },
                  { text: '中', value: 'medium' },
                  { text: '高', value: 'high' },
                  { text: '紧急', value: 'critical' },
                ],
              },
              {
                key: 'owner',
                label: '负责人',
                type: 'select',
                options: [
                  { text: '陈晓', value: '陈晓' },
                  { text: '刘伟', value: '刘伟' },
                  { text: '赵云', value: '赵云' },
                  { text: '林雪', value: '林雪' },
                ],
              },
            ],
            priorityMap: {
              low: 2,
              medium: 3,
              high: 4,
              critical: 5,
            },
            statusColorMap: {
              planning: 'indigo',
              running: 'blue',
              finished: 'success',
            },
            statusTextMap: {
              planning: '规划中',
              running: '进行中',
              finished: '已交付',
            },
            selectedRows: [],
            modalVisible: false,
            modalTitle: '新增项目',
            modalFields: [
              { key: 'name', label: '项目名称', required: true, placeholder: '请输入项目名称' },
              { key: 'owner', label: '负责人', required: true, placeholder: '例如：陈晓' },
              {
                key: 'status',
                label: '状态',
                type: 'select',
                required: true,
                options: [
                  { text: '规划中', value: 'planning' },
                  { text: '进行中', value: 'running' },
                  { text: '已交付', value: 'finished' },
                ],
              },
              {
                key: 'priority',
                label: '优先级',
                type: 'select',
                options: [
                  { text: '低', value: 'low' },
                  { text: '中', value: 'medium' },
                  { text: '高', value: 'high' },
                  { text: '紧急', value: 'critical' },
                ],
              },
              {
                key: 'members',
                label: '成员人数',
                type: 'number',
                props: { min: 1 },
              },
              {
                key: 'description',
                label: '背景描述',
                type: 'textarea',
                rows: 3,
                extra: '可补充关键节点、预计上线时间等信息',
              },
            ],
            currentProject: {},
            nextProjectId: mockProjects.length + 1,
            tempStore: [...mockProjects],
            toast: {
              visible: false,
              message: '',
              type: 'success',
            },
            quickFormFields: [
              { key: 'quickName', label: '项目名', required: true, placeholder: '例如：统一消息' },
              {
                key: 'quickOwner',
                label: '负责人',
                required: true,
                placeholder: '填写负责人',
              },
              {
                key: 'quickPriority',
                label: '优先级',
                type: 'select',
                options: [
                  { text: '中', value: 'medium' },
                  { text: '高', value: 'high' },
                  { text: '紧急', value: 'critical' },
                ],
                required: true,
              },
            ],
            quickFormData: {
              quickPriority: 'medium',
            },
          };
        },
        methods: {
          async loadProjects(params = {}) {
            const { page = 1, pageSize = 10, search = '', filters = {} } = params;
            const lowerSearch = (search || '').toLowerCase();
            let records = this.tempStore.slice();

            if (lowerSearch) {
              records = records.filter((item) =>
                item.name.toLowerCase().includes(lowerSearch)
              );
            }

            if (filters.status) {
              records = records.filter((item) => item.status === filters.status);
            }
            if (filters.priority) {
              records = records.filter((item) => item.priority === filters.priority);
            }
            if (filters.name) {
              records = records.filter((item) =>
                item.name.toLowerCase().includes(filters.name.toLowerCase())
              );
            }
            if (filters.owner) {
              records = records.filter((item) => item.owner === filters.owner);
            }

            const total = records.length;
            const start = (page - 1) * pageSize;
            const data = records.slice(start, start + pageSize);

            return new Promise((resolve) => {
              setTimeout(() => {
                resolve({
                  data,
                  total,
                  success: true,
                });
              }, 500);
            });
          },
          openCreateForm() {
            this.modalTitle = '新增项目';
            this.currentProject = {
              status: 'planning',
              priority: 'medium',
              members: 5,
            };
            this.modalVisible = true;
          },
          openEditForm(item) {
            this.modalTitle = `编辑：${item.name}`;
            this.currentProject = { ...item };
            this.modalVisible = true;
          },
          async handleModalConfirm(formData) {
            if (formData.id) {
              const index = this.tempStore.findIndex((item) => item.id === formData.id);
              if (index > -1) {
                this.tempStore.splice(index, 1, {
                  ...this.tempStore[index],
                  ...formData,
                  updatedAt: new Date().toISOString().slice(0, 10),
                });
              }
              this.showToast('项目已更新');
            } else {
              this.tempStore.unshift({
                ...formData,
                id: this.nextProjectId++,
                updatedAt: new Date().toISOString().slice(0, 10),
              });
              this.showToast('新增项目成功');
            }
            this.modalVisible = false;
            this.refreshTable();
          },
          handleModalClose() {
            this.modalVisible = false;
          },
          markFinished(item) {
            item.status = 'finished';
            this.showToast(`「${item.name}」已标记为完成`, 'success');
            this.refreshTable();
          },
          onTableSelection(payload) {
            this.selectedRows = payload.selectedRows || [];
          },
          exportSelected() {
            if (this.selectedRows.length === 0) {
              this.showToast('请先选择项目后再导出', 'warning');
              return;
            }
            // TODO: 接入真实导出接口
            this.showToast(`已导出 ${this.selectedRows.length} 个项目`, 'success');
          },
          refreshTable() {
            this.$refs.projectTable && this.$refs.projectTable.reload();
          },
          showToast(message, type = 'success') {
            this.toast = {
              visible: true,
              message,
              type,
            };
          },
          handleQuickSubmit(data) {
            // TODO: 将数据提交到后端
            this.showToast(`已快速登记「${data.quickName}」`, 'success');
          },
          handleQuickChange({ key, value }) {
            console.log('字段变化', key, value);
          },
        },
      });
    </script>
  </body>
</html>
